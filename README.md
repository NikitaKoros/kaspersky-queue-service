# README.md

## Структура проекта

```
.
├── cmd/
│   └── main.go                     # Главный запуск сервера
├── internal/
│   ├── config/                     # Чтение конфигурации из переменных окружения
│   │   └── config.go
│   ├── controller/                 # Основной контроллер бизнес-логики
│   │   ├── controller.go           # Логика управления задачами
│   │   └── controller_test.go      # Тесты контроллера
│   ├── handler/                    # HTTP-обработчики
│   │   ├── handlers.go             # Методы /enqueue и /healthz
│   │   └── server.go               # Серверная логика (включая маршруты)
│   ├── queue/                      # Очередь и пулы воркеров
│   │   ├── queue.go                # Буферизированная очередь с ограничением размера
│   │   ├── worker_pool.go          # Пул воркеров, обрабатывающих задачи
│   │   ├── queue_test.go           # Тесты очереди
│   │   └── worker_pool_test.go     # Тесты пула воркеров
│   ├── shutdown/                   # Управление завершением работы
│   │   ├── shutdown.go             # Координатор завершения
│   │   └── shutdown_test.go        # Тесты координатора
│   └── store/                      # Хранение состояния задач
│       ├── store.go                # Хранение и управление состоянием задач
│       └── store_test.go           # Тесты хранилища
├── .env                            # Файл с переменными окружения
├── .gitignore
├── go.mod
├── Makefile                      # Makefile для запуска и тестирования
└── README.md
```

## Описание компонентов

### `cmd/main.go`  
Точка входа в приложение. Запускает HTTP-сервер, инициализирует конфигурацию, контроллер и координатор завершения. Регистрирует обработчики сигналов `SIGINT` и `SIGTERM`, обеспечивая корректное завершение работы.

### `internal/config/config.go`  
Чтение конфигурации из переменных окружения:
- `WORKERS` — количество воркеров (по умолчанию 4)
- `QUEUE_SIZE` — размер очереди (по умолчанию 64)
- `BASE_BACKOFF_MS` — базовое время задержки (по умолчанию 100 мс)
- `MAX_BACKOFF_MS` — максимальная задержка (по умолчанию 10 секунд)
- `SERVER_ADDR` — адрес сервера (по умолчанию `:8080`)

Функции `getEnvAsInt` и `getEnvAsString` обеспечивают безопасное чтение значений с fallback.

### `internal/controller/controller.go`  
Центральный контроллер, который:
- Использует очередь (`queue.QueueProvider`) и хранилище состояний (`store.StoreProvider`)
- Реализует метод `EnqueueTask` для добавления задачи в очередь
- Отслеживает состояние задач через `GetHealthStats`
- Проверяет, принимает ли сервис новые задачи (`IsAccepting`)

При ошибке записи в очередь задача удаляется из хранилища, чтобы не оставалось "зависших" записей.

### `internal/handler/handlers.go` и `server.go`  
HTTP-обработчики:
- `HandleEnqueue`: принимает POST-запрос с JSON-телом, проверяет валидность данных и передаёт задачу контроллеру
- `HandleHealth`: возвращает статус здоровья сервиса с метриками по задачам и очереди

Оба обработчика используют `controller.ControllerProvider` для взаимодействия с бизнес-логикой.

## `internal/queue/queue.go`

**Описание:**  
Реализация буферизированной очереди задач с фиксированным размером. Используется канал `chan *Task` для хранения задач. Очередь реализует интерфейс `QueueProvider`.

**Ключевые функции:**
- `NewQueue(size int)`: создаёт новую очередь заданного размера
- `Enqueue(task *Task) error`: добавляет задачу в очередь, возвращает `ErrQueueFull`, если очередь переполнена
- `Dequeue(ctx context.Context) (*Task, bool)`: извлекает задачу из очереди или возвращает `false`, если контекст отменён
- `Size() int` и `Capacity() int`: возвращают текущий размер и максимальную ёмкость очереди

**Особенности:**
- Использует `select` для безопасного добавления/удаления без блокировки
- Поддерживает отмену операций через `context.Context`

## `internal/queue/worker_pool.go`

**Описание:**  
Пул воркеров, отвечающий за обработку задач из очереди. Каждый воркер извлекает задачу, имитирует её выполнение (100–500 мс), может симулировать ошибку (20%) и реализует экспоненциальный бэкофф с джиттером при повторных попытках.

**Ключевые функции:**
- `NewWorkerPool(...)`: создаёт пул с заданным количеством воркеров, параметрами бэкоффа и хранилищем состояний
- `Start()`: запускает все воркеры в горутинах
- `Stop(timeout time.Duration)`: останавливает пул с таймаутом, ожидая завершения всех задач
- `worker(id int)`: основной цикл воркера — извлекает задачу, обрабатывает её, управляет повторами
- `processTask(task *Task, workerID int)`: выполняет задачу, симулирует работу и ошибку
- `scheduleRetry(...)`: планирует повторную попытку с задержкой
- `calculateBackoff(attempts int)`: вычисляет экспоненциальную задержку с ограничением до `maxBackoff`

**Особенности:**
- Добавлен **джиттер** (`rand.Int63n(int64(backoff))`) для предотвращения синхронных повторов
- При сбое задача переходит в состояние `queued`, а не сразу `failed`
- Если превышено `max_retries`, задача помечается как `failed` навсегда
- Поддержка отмены через `context.Done()` — задача не будет повторяться, если процесс завершается

## `internal/shutdown/shutdown.go`

**Описание:**  
Координатор завершения работы сервиса. Реализует грейсфул шатдаун: прекращает принятие новых задач, ждёт завершения текущих, затем завершает работу.

**Ключевые функции:**
- `NewCoordinator()`: создаёт новый координатор, подписывается на `SIGINT` и `SIGTERM`
- `IsAccepting() bool`: возвращает `true`, если сервис всё ещё принимает задачи
- `initiateShutdown()`: устанавливает флаг `accepting = false` и отправляет сигнал завершения
- `waitForSignal()`: запускает фоновую горутину для прослушивания сигналов
- `ShutdownWithTimeout(timeout time.Duration, ...func(context.Context))`: вызывает `initiateShutdown()` и запускает список функций завершения с таймаутом

**Особенности:**
- Использует `atomic.Bool` для быстрого чтения состояния
- Гарантирует, что `shutdown` вызывается только один раз (`sync.Once`)
- Возвращает `context.WithTimeout` для контроля времени ожидания завершения

## `internal/store/store.go`

**Описание:**  
Хранилище состояний задач в памяти. Реализует интерфейс `StoreProvider` и отвечает за управление жизненным циклом задач.

**Состояния задач:**
- `queued`: задача в очереди
- `running`: задача выполняется
- `done`: успешно завершена
- `failed`: завершена с ошибкой

**Ключевые функции:**
- `CreateTask(id string) error`: создаёт новую задачу с состоянием `queued`, возвращает `ErrTaskExists`, если уже существует
- `DeleteTask(id string) error`: удаляет задачу из хранилища
- `UpdateTaskState(id string, newState TaskState, reason string) error`: обновляет состояние и причину изменения
- `GetStats() map[TaskState]int`: возвращает статистику по состояниям задач

**Особенности:**
- Использует `sync.RWMutex` для безопасного доступа к данным
- Хранит `reason` для последующего анализа ошибок
- Полностью in-memory хранилище

## Как запустить проект

1. Создайте файл `.env` (или используйте переменные окружения):

```env
WORKERS=4
QUEUE_SIZE=64
SERVER_ADDR=:8080
BASE_BACKOFF_MS=100
MAX_BACKOFF_MS=10000
```

2. Запустите сервер:

```bash
go run cmd/main.go
```

Сервер будет доступен по адресу `http://localhost:8080`.

## Как запустить тесты

Использование `Makefile` :

```bash
make test    # Запуск всех тестов
make run     # Запуск сервера

```